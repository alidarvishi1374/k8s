apiVersion: v1
kind: ConfigMap
metadata:
  name: csr-config
  namespace: {{ .Values.namespace }}
  annotations:
    "helm.sh/hook": pre-install
    "helm.sh/hook-weight": "-1"
data:
  csr.conf: |
    [ req ]
    distinguished_name = req_distinguished_name
    req_extensions = v3_req
    prompt = no

    [ req_distinguished_name ]
    CN = policy-webhook.{{ .Values.namespace }}.svc

    [ v3_req ]
    keyUsage = critical, digitalSignature, keyEncipherment
    extendedKeyUsage = serverAuth
    subjectAltName = @alt_names

    [ alt_names ]
    DNS.1 = policy-webhook
    DNS.2 = policy-webhook.{{ .Values.namespace }}
    DNS.3 = policy-webhook.{{ .Values.namespace }}.svc
    DNS.4 = localhost
